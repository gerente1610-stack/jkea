<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JKA INMOBILIARIA | Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; scroll-behavior: smooth; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); }
        .hero-gradient { background: radial-gradient(circle at top right, #1e3a8a 0%, #0f172a 60%); }
        .house-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.05); }
        .house-card:hover { transform: translateY(-12px); border-color: #3b82f6; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .badge-info { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); color: #93c5fd; font-size: 10px; padding: 4px 10px; border-radius: 8px; font-weight: 600; text-transform: uppercase; }
    </style>
</head>
<body>

    <nav class="sticky top-0 z-50 glass border-b border-slate-800 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center font-black text-white italic shadow-lg">JK</div>
                <h1 class="text-xl font-extrabold tracking-tighter text-white uppercase">JKA <span class="text-blue-500 font-light italic">INMOBILIARIA</span></h1>
            </div>
            <div class="flex items-center gap-6 text-[11px] font-bold text-slate-400">
                <a href="#catalogo" class="hover:text-blue-400 transition uppercase tracking-widest">Propiedades</a>
                <button onclick="revealAdmin()" class="bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 hover:bg-slate-700 transition text-[9px]">ADMIN</button>
            </div>
        </div>
    </nav>

    <section class="relative min-h-[40vh] flex items-center justify-center text-center px-6 hero-gradient">
        <div class="max-w-4xl z-10">
            <h2 class="text-5xl md:text-7xl font-extrabold text-white mb-6 uppercase tracking-tighter italic">Gestión de <br><span class="text-blue-500 font-light italic">Propiedades.</span></h2>
        </div>
    </section>

    <section id="catalogo" class="py-20 bg-[#0f172a]">
        <div class="max-w-7xl mx-auto px-6 text-center">
            
            <div id="adminPanel" class="hidden max-w-4xl mx-auto mb-20 p-8 bg-slate-900 border-2 border-blue-600/40 rounded-[2.5rem] shadow-2xl">
                <h3 class="text-white font-black mb-6 uppercase italic text-sm">Registrar Nueva Propiedad</h3>
                <form id="houseForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-left">
                    <input type="text" id="imgInp" placeholder="Link de Foto (URL)" class="md:col-span-2 p-4 bg-slate-800 rounded-xl border border-slate-700 text-white" required>
                    <input type="text" id="streetInp" placeholder="Calle y Número" class="p-4 bg-slate-800 rounded-xl border border-slate-700 text-white" required>
                    <input type="text" id="colInp" placeholder="Colonia" class="p-4 bg-slate-800 rounded-xl border border-slate-700 text-white" required>
                    <input type="text" id="munInp" placeholder="Municipio" class="p-4 bg-slate-800 rounded-xl border border-slate-700 text-white" required>
                    <input type="text" id="estInp" placeholder="Estado" class="p-4 bg-slate-800 rounded-xl border border-slate-700 text-white" required>
                    <input type="text" id="priceInp" placeholder="Precio (Sólo números)" class="p-4 bg-slate-800 rounded-xl border border-slate-700 text-white" required>
                    <input type="text" id="avaInp" placeholder="Valor de Avalúo" class="p-4 bg-slate-800 rounded-xl border border-slate-700 text-white">
                    <input type="text" id="carInp" placeholder="Tipo de Carta" class="p-4 bg-slate-800 rounded-xl border border-slate-700 text-white">
                    <input type="text" id="mapsInp" placeholder="Link Google Maps" class="md:col-span-2 p-4 bg-slate-800 rounded-xl border border-slate-700 text-white">
                    <textarea id="descInp" placeholder="Descripción breve..." class="md:col-span-2 p-4 bg-slate-800 rounded-xl border border-slate-700 h-24 text-white"></textarea>
                    <button type="submit" id="submitBtn" class="md:col-span-2 bg-blue-600 p-5 rounded-xl font-black uppercase text-white hover:bg-blue-500 transition shadow-lg">Publicar Propiedad</button>
                </form>
            </div>

            <main id="container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></main>
        </div>
    </section>

    <script>
        // URLs ACTUALIZADAS
        const SHEET_PROPIEDADES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQf7b5O2BeNcp2h9YQrBYdGiyQ0Z22piNbVoPWUl4mJIEbX-zxCHsxthpQmF3eRTLEgIFXa4lODMK/pub?output=csv';
        const SHEET_USUARIOS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQf7b5O2BeNcp2h9YQrBYdGiyQ0Z22piNbVoPWUl4mJIEbX-zxCHsxthpQmF3eRTLEgIFXa4lODMK/pub?gid=844715514&single=true&output=csv';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby16-dfSYOhBMP551jDEr1-c6XhTuqhpbT1Wfzg4XA8y1S5Ib8uyoZhGLBQVZuuUveU3g/exec';

        function getRowsFromCSV(text) {
            const rows = []; let curr = []; let field = ''; let inQ = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"') inQ = !inQ;
                else if (c === ',' && !inQ) { curr.push(field.trim()); field = ''; }
                else if (c === '\n' && !inQ) { curr.push(field.trim()); rows.push(curr); curr = []; field = ''; }
                else if (c !== '\r') field += c;
            }
            if (curr.length || field) { curr.push(field.trim()); rows.push(curr); }
            return rows;
        }

        async function revealAdmin() {
            const u = prompt("Usuario:");
            const p = prompt("Contraseña:");
            if (!u || !p) return;
            try {
                const res = await fetch(SHEET_USUARIOS + '&cb=' + Date.now());
                const text = await res.text();
                const users = getRowsFromCSV(text);
                let ok = false;
                for (let i = 1; i < users.length; i++) {
                    if (users[i][0] === u && users[i][2] === p && users[i][3].toLowerCase().includes("admin")) { ok = true; break; }
                }
                if (ok) {
                    document.getElementById('adminPanel').classList.toggle('hidden');
                    document.getElementById('adminPanel').scrollIntoView();
                } else { alert("Credenciales incorrectas."); }
            } catch (e) { alert("Error al validar."); }
        }

        async function loadHouses() {
            try {
                const res = await fetch(SHEET_PROPIEDADES + '&cb=' + Date.now());
                const text = await res.text();
                const data = getRowsFromCSV(text);
                const container = document.getElementById('container');
                container.innerHTML = "";

                for (let i = 1; i < data.length; i++) {
                    const r = data[i];
                    if (r.length < 11 || (r[11] || "").toLowerCase() !== "disponible") continue;
                    
                    const pFmt = Number(r[6].replace(/[^0-9.]/g, '')).toLocaleString('es-MX');
                    container.innerHTML += `
                        <div class="house-card bg-[#1e293b] rounded-[2.5rem] overflow-hidden flex flex-col h-full shadow-2xl text-left border border-slate-800">
                            <img src="${r[1]}" class="h-64 w-full object-cover">
                            <div class="p-8 flex flex-col flex-grow">
                                <h3 class="text-3xl font-black text-white mb-2">$${pFmt}</h3>
                                <p class="text-slate-400 text-[11px] font-bold mb-4 uppercase italic italic"><i class="fa-solid fa-location-dot text-blue-500 mr-1"></i> ${r[2]}, ${r[3]}</p>
                                <div class="flex flex-wrap gap-2 mb-6">
                                    <span class="badge-info">Avalúo: ${r[7] || 'N/A'}</span>
                                    <span class="badge-info">Carta: ${r[8] || 'N/A'}</span>
                                </div>
                                <p class="text-slate-500 text-[11px] italic mb-8 line-clamp-4 leading-relaxed italic">"${r[9]}"</p>
                                <div class="grid gap-3 mt-auto">
                                    <a href="https://wa.me/528115041788" target="_blank" class="bg-[#25D366] text-white py-4 rounded-2xl font-black text-[10px] text-center uppercase shadow-lg">WhatsApp</a>
                                    <a href="${r[10]}" target="_blank" class="text-slate-600 text-[9px] text-center uppercase font-bold hover:text-blue-400">Ver Mapa</a>
                                </div>
                            </div>
                        </div>`;
                }
            } catch (e) { console.error(e); }
        }

        // FUNCIÓN DE ENVÍO CORREGIDA
        document.getElementById('houseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = "PROCESANDO ENVÍO...";
            btn.disabled = true;

            const payload = {
                imagen: document.getElementById('imgInp').value,
                calle: document.getElementById('streetInp').value,
                colonia: document.getElementById('colInp').value,
                municipio: document.getElementById('munInp').value,
                estado: document.getElementById('estInp').value,
                precio: document.getElementById('priceInp').value,
                avaluo: document.getElementById('avaInp').value,
                carta: document.getElementById('carInp').value,
                descripcion: document.getElementById('descInp').value,
                maps: document.getElementById('mapsInp').value
            };

            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("¡DATOS ENVIADOS!\nLa propiedad aparecerá en el catálogo tras actualizar.");
                location.reload();
            }).catch(err => {
                alert("Error de envío.");
                btn.disabled = false;
                btn.innerHTML = "Publicar Propiedad";
            });
        });

        loadHouses();
    </script>
</body>
</html>